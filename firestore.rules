rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ========================================================================
     * Regole di sicurezza con Firebase Authentication
     * ======================================================================== */

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      return request.auth != null &&
             request.auth.token.get('admin', false) == true;
    }

    /* ===================== UTENTI (USERS) ================================
     * Collezione: /users/{userId}
     * Profilo utente con nickname, nome, cognome, email
     * ==================================================================== */
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    /* ===================== CLASSIFICA (RANKING) ==========================
     * Collezione: /ranking/{userId}
     * Dati di gioco: punti, jolly, formazioni campionato
     * ==================================================================== */
    match /ranking/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId) || isAdmin();
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    /* ===================== GARE (RACES) ==================================
     * Collezione: /races/{raceId}
     * Dati gara: nome, date, risultati ufficiali
     * ==================================================================== */
    match /races/{raceId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();

      /* ================= FORMAZIONI (SUBMISSIONS) ========================
       * Subcollection: /races/{raceId}/submissions/{userId}
       * Formazioni dei giocatori per ogni gara
       * =================================================================== */
      match /submissions/{userId} {
        allow read: if isAuthenticated();
        allow create, update: if isOwner(userId) || isAdmin();
        allow delete: if isAdmin();
      }
    }

    /* ===================== CAMPIONATO (CHAMPIONSHIP) =====================
     * Collezione: /championship/{docId}
     * Risultati finali campionato
     * ==================================================================== */
    match /championship/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    /* ===================== BACKUP DATABASE ================================
     * Collezione: /backups/{backupId}
     * Backup completi del database
     * ==================================================================== */
    match /backups/{backupId} {
      allow read, write: if isAdmin();
    }

    /* ===================== STORICO CLASSIFICA =============================
     * Collezione: /rankingHistory/{snapshotId}
     * Snapshot storici della classifica
     * ==================================================================== */
    match /rankingHistory/{snapshotId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    /* ===================== FALLBACK ======================================
     * Blocca accesso a qualsiasi altra collezione non definita sopra
     * ==================================================================== */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
