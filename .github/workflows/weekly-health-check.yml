name: üè• Weekly Health Check

on:
  # Esegui ogni luned√¨ alle 09:00 UTC
  schedule:
    - cron: '0 9 * * 1'

  # Permetti esecuzione manuale
  workflow_dispatch:

jobs:
  health-check:
    name: Quick Health Check
    runs-on: ubuntu-latest

    steps:
      - name: üìä Fetch stats
        id: stats
        run: |
          STATS=$(curl -s https://europe-west1-fantaf1-b5410.cloudfunctions.net/getNotificationStats)

          # Estrai metriche chiave
          TOTAL_TOKENS=$(echo "$STATS" | grep -o '"totalTokens":[0-9]*' | cut -d':' -f2 || echo "0")
          TOTAL_NOTIFICATIONS=$(echo "$STATS" | grep -o '"totalNotificationsSent":[0-9]*' | cut -d':' -f2 || echo "0")

          echo "TOTAL_TOKENS=$TOTAL_TOKENS" >> $GITHUB_OUTPUT
          echo "TOTAL_NOTIFICATIONS=$TOTAL_NOTIFICATIONS" >> $GITHUB_OUTPUT

          # Verifica che l'endpoint risponda
          if [ -z "$TOTAL_TOKENS" ]; then
            echo "‚ö†Ô∏è Impossibile recuperare statistiche"
            echo "HEALTH_STATUS=WARNING" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Statistiche recuperate con successo"
            echo "HEALTH_STATUS=OK" >> $GITHUB_OUTPUT
          fi

      - name: üîç Check for anomalies
        id: anomaly_check
        run: |
          TOKENS=${{ steps.stats.outputs.TOTAL_TOKENS }}
          PREV_TOKENS=25  # Valore atteso baseline

          ANOMALY=false

          # Check 1: Troppe registrazioni
          if [ "$TOKENS" -gt 100 ]; then
            echo "‚ö†Ô∏è WARNING: Token count elevato: $TOKENS (atteso ~25)"
            ANOMALY=true
          fi

          # Check 2: Nessuna registrazione (possibile problema)
          if [ "$TOKENS" -eq 0 ]; then
            echo "‚ö†Ô∏è WARNING: Nessun token registrato (possibile problema)"
            ANOMALY=true
          fi

          if [ "$ANOMALY" = true ]; then
            echo "HAS_ANOMALY=true" >> $GITHUB_OUTPUT
          else
            echo "HAS_ANOMALY=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Tutto normale"
          fi

      - name: üìß Send alert email (only if anomaly)
        if: steps.anomaly_check.outputs.HAS_ANOMALY == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚ö†Ô∏è FantaF1 - Anomalia Rilevata nel Check Settimanale"
          to: ${{ secrets.EMAIL_TO }}
          from: FantaF1 Health Monitor
          body: |
            ‚ö†Ô∏è ANOMALIA RILEVATA

            Il controllo settimanale ha rilevato un'anomalia nel sistema di notifiche.

            Dispositivi registrati: ${{ steps.stats.outputs.TOTAL_TOKENS }}
            Notifiche inviate (totale): ${{ steps.stats.outputs.TOTAL_NOTIFICATIONS }}

            Azione richiesta:
            1. Verifica Firebase Console
            2. Controlla Google Cloud Billing per costi imprevisti
            3. Analizza logs delle Cloud Functions

            Link:
            - Firebase Console: https://console.firebase.google.com/project/fantaf1-b5410
            - Cloud Billing: https://console.cloud.google.com/billing
            - GitHub Actions: https://github.com/${{ github.repository }}/actions

            ---
            FantaF1 Weekly Health Check

      - name: üí¨ Send Telegram notification (optional)
        if: steps.anomaly_check.outputs.HAS_ANOMALY == 'true'
        continue-on-error: true
        run: |
          if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]; then
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d text="‚ö†Ô∏è *FantaF1 Alert*%0A%0AAnomalia rilevata:%0ADispositivi: ${{ steps.stats.outputs.TOTAL_TOKENS }}%0A%0AVedi GitHub Actions per dettagli." \
              -d parse_mode="Markdown"
          else
            echo "‚ÑπÔ∏è Telegram non configurato (opzionale)"
          fi

      - name: ‚úÖ Success summary
        if: steps.anomaly_check.outputs.HAS_ANOMALY == 'false'
        run: |
          echo "‚úÖ Sistema in salute"
          echo "üì± Dispositivi: ${{ steps.stats.outputs.TOTAL_TOKENS }}"
          echo "üì¨ Notifiche: ${{ steps.stats.outputs.TOTAL_NOTIFICATIONS }}"
          echo "üí∞ Costo stimato: ‚Ç¨0.00"
