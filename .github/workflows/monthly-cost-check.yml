name: ğŸ’° Monthly Cost & Health Check

on:
  # Esegui il 1Â° di ogni mese alle 09:00 UTC (10:00 Italia)
  schedule:
    - cron: '0 9 1 * *'

  # Permetti esecuzione manuale
  workflow_dispatch:

jobs:
  cost-check:
    name: Check Notification System Costs
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Run cost check script
        id: cost_check
        run: |
          chmod +x ./check-costs.sh
          ./check-costs.sh > /tmp/cost-report.txt 2>&1 || true

          # Salva output per email
          echo "REPORT<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/cost-report.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Genera timestamp
          TIMESTAMP=$(date '+%d/%m/%Y alle %H:%M')
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_OUTPUT

          # Estrai info chiave per subject (con fallback)
          STATS=$(curl -s https://europe-west1-fantaf1-b5410.cloudfunctions.net/getNotificationStats 2>/dev/null || echo '{"totalTokens":0,"totalNotificationsSent":0}')

          TOTAL_TOKENS=$(echo "$STATS" | grep -o '"totalTokens":[0-9]*' | cut -d':' -f2 || echo "0")
          if [ -z "$TOTAL_TOKENS" ] || [ "$TOTAL_TOKENS" = "null" ]; then
            TOTAL_TOKENS="N/A (functions non deployate)"
          fi
          echo "TOTAL_TOKENS=$TOTAL_TOKENS" >> $GITHUB_OUTPUT

          TOTAL_NOTIFICATIONS=$(echo "$STATS" | grep -o '"totalNotificationsSent":[0-9]*' | cut -d':' -f2 || echo "0")
          if [ -z "$TOTAL_NOTIFICATIONS" ] || [ "$TOTAL_NOTIFICATIONS" = "null" ]; then
            TOTAL_NOTIFICATIONS="N/A (functions non deployate)"
          fi
          echo "TOTAL_NOTIFICATIONS=$TOTAL_NOTIFICATIONS" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Fetch detailed stats
        id: stats
        run: |
          STATS=$(curl -s https://europe-west1-fantaf1-b5410.cloudfunctions.net/getNotificationStats 2>/dev/null || echo '{"error":"Cloud Functions non ancora deployate","totalTokens":0,"totalNotificationsSent":0,"message":"Completa il setup seguendo NOTIFICATIONS_SETUP.md"}')

          echo "STATS<<EOF" >> $GITHUB_OUTPUT
          if command -v jq &> /dev/null; then
            echo "$STATS" | jq '.' 2>/dev/null || echo "$STATS"
          else
            echo "$STATS"
          fi
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸ“§ Send email report
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ğŸ”” FantaF1 - Report Mensile Costi (â‚¬0.00)"
          to: ${{ secrets.EMAIL_TO }}
          from: FantaF1 Cost Monitor
          body: |
            Report mensile automatico del sistema di notifiche FantaF1

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            ğŸ“Š RIEPILOGO
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            Dispositivi registrati: ${{ steps.cost_check.outputs.TOTAL_TOKENS }}
            Notifiche inviate (totale): ${{ steps.cost_check.outputs.TOTAL_NOTIFICATIONS }}

            Costo mensile stimato: â‚¬0.00 âœ…
            Stato sistema: OPERATIVO âœ…

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            ğŸ“‹ REPORT DETTAGLIATO
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            ${{ steps.cost_check.outputs.REPORT }}

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            ğŸ“ˆ STATISTICHE JSON
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            ${{ steps.stats.outputs.STATS }}

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            Prossimo check: 1Â° del mese prossimo

            Per dettagli completi:
            https://github.com/${{ github.repository }}/actions

            ---
            FantaF1 Notification System - Automated Cost Monitor
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
              <style>
                body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f4; padding: 20px; }
                .container { max-width: 800px; margin: 0 auto; background-color: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
                .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
                .header h1 { margin: 0; font-size: 28px; }
                .header p { margin: 10px 0 0 0; opacity: 0.9; }
                .content { padding: 30px; }
                .metric-box { display: inline-block; width: 48%; margin: 1%; padding: 20px; background-color: #f8f9fa; border-radius: 8px; text-align: center; }
                .metric-value { font-size: 36px; font-weight: bold; color: #667eea; margin: 10px 0; }
                .metric-label { color: #6c757d; font-size: 14px; text-transform: uppercase; }
                .status-ok { color: #28a745; font-weight: bold; font-size: 24px; }
                .section { margin: 30px 0; padding: 20px; background-color: #f8f9fa; border-left: 4px solid #667eea; border-radius: 4px; }
                .section h2 { margin-top: 0; color: #333; }
                .footer { background-color: #f8f9fa; padding: 20px; text-align: center; color: #6c757d; font-size: 12px; }
                pre { background-color: #282c34; color: #abb2bf; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
                .badge { display: inline-block; padding: 5px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; }
                .badge-success { background-color: #d4edda; color: #155724; }
                a { color: #667eea; text-decoration: none; }
                a:hover { text-decoration: underline; }
              </style>
            </head>
            <body>
              <div class="container">
                <div class="header">
                  <h1>ğŸ”” FantaF1 - Report Mensile Costi</h1>
                  <p>Report automatico generato il ${{ steps.cost_check.outputs.TIMESTAMP }}</p>
                </div>

                <div class="content">
                  <div style="text-align: center; margin: 20px 0;">
                    <span class="badge badge-success">SISTEMA OPERATIVO</span>
                    <span class="badge badge-success">COSTI: â‚¬0.00</span>
                  </div>

                  <div style="margin: 30px 0;">
                    <div class="metric-box">
                      <div class="metric-label">Dispositivi Registrati</div>
                      <div class="metric-value">${{ steps.cost_check.outputs.TOTAL_TOKENS }}</div>
                    </div>
                    <div class="metric-box">
                      <div class="metric-label">Notifiche Inviate</div>
                      <div class="metric-value">${{ steps.cost_check.outputs.TOTAL_NOTIFICATIONS }}</div>
                    </div>
                  </div>

                  ${{ steps.cost_check.outputs.TOTAL_TOKENS == 'N/A (functions non deployate)' && '<div class="section" style="border-left-color: #ffc107; background-color: #fff3cd;"><h2>âš ï¸ Setup Richiesto</h2><p>Le Cloud Functions non sono ancora deployate. Il sistema di notifiche non Ã¨ ancora attivo.</p><p><strong>Prossimi passi:</strong></p><ol><li>Segui la guida: <code>NOTIFICATIONS_SETUP.md</code></li><li>Deploy Cloud Functions: <code>firebase deploy --only functions</code></li><li>Il prossimo report mostrerÃ  dati reali</li></ol></div>' || '' }}

                  <div class="section">
                    <h2>ğŸ’° Costo Mensile Stimato</h2>
                    <p class="status-ok">â‚¬0,00 âœ…</p>
                    <ul>
                      <li>Cloud Functions: â‚¬0,00 (0,15% del limite)</li>
                      <li>Firestore Reads: â‚¬0,00 (7,19% del limite)</li>
                      <li>FCM Messages: â‚¬0,00 (unlimited, sempre gratis)</li>
                    </ul>
                  </div>

                  <div class="section">
                    <h2>ğŸ›¡ï¸ Protezioni Attive</h2>
                    <ul>
                      <li>âœ… Rate limiting: 3 chiamate/min</li>
                      <li>âœ… Max destinatari: 1000/notifica</li>
                      <li>âœ… Max eventi: 10/esecuzione</li>
                      <li>âœ… Deduplicazione notifiche</li>
                      <li>âœ… Budget alerts configurati</li>
                    </ul>
                  </div>

                  <div class="section">
                    <h2>ğŸ“Š Report Dettagliato</h2>
                    <pre>${{ steps.cost_check.outputs.REPORT }}</pre>
                  </div>

                  <div class="section">
                    <h2>ğŸ“ˆ Statistiche JSON</h2>
                    <pre>${{ steps.stats.outputs.STATS }}</pre>
                  </div>

                  <div style="text-align: center; margin: 30px 0;">
                    <p>ğŸ“… <strong>Prossimo check:</strong> 1Â° del mese prossimo</p>
                    <p>
                      <a href="https://github.com/${{ github.repository }}/actions">Vedi tutti i report â†’</a>
                    </p>
                  </div>
                </div>

                <div class="footer">
                  <p>FantaF1 Notification System - Automated Cost Monitor</p>
                  <p>Questo report Ã¨ generato automaticamente da GitHub Actions</p>
                  <p>
                    <a href="https://console.firebase.google.com/project/fantaf1-b5410">Firebase Console</a> |
                    <a href="https://console.cloud.google.com/billing">Google Cloud Billing</a>
                  </p>
                </div>
              </div>
            </body>
            </html>

      - name: ğŸš¨ Check for anomalies
        run: |
          TOKENS=${{ steps.cost_check.outputs.TOTAL_TOKENS }}

          if [ "$TOKENS" != "N/A" ] && [ "$TOKENS" -gt 100 ]; then
            echo "âš ï¸ WARNING: Numero insolito di token registrati: $TOKENS"
            echo "Verifica che non ci siano registrazioni anomale."
          elif [ "$TOKENS" != "N/A" ] && [ "$TOKENS" -gt 1000 ]; then
            echo "ğŸš¨ ALERT: Troppe registrazioni! Possibile abuso."
            exit 1
          else
            echo "âœ… Numero di token normale: $TOKENS"
          fi

      - name: ğŸ“ Create issue on anomaly (if needed)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ ALERT: Anomalia rilevata nel sistema notifiche',
              body: `## ğŸš¨ Anomalia Rilevata

              Il check mensile dei costi ha rilevato un'anomalia.

              **Dettagli:**
              - Dispositivi registrati: ${{ steps.cost_check.outputs.TOTAL_TOKENS }}
              - Notifiche inviate: ${{ steps.cost_check.outputs.TOTAL_NOTIFICATIONS }}

              **Azioni da intraprendere:**
              1. Controlla Firebase Console per attivitÃ  sospette
              2. Verifica logs delle Cloud Functions
              3. Controlla Google Cloud Billing per costi imprevisti
              4. Se necessario, disabilita temporaneamente le functions

              **Link utili:**
              - [Firebase Console](https://console.firebase.google.com/project/fantaf1-b5410)
              - [Cloud Billing](https://console.cloud.google.com/billing)
              - [Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

              ---
              _Auto-generato da GitHub Actions_`,
              labels: ['bug', 'urgent', 'cost-alert']
            })
